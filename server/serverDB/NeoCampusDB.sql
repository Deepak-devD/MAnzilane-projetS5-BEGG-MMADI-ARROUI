-- PARENT TABLES
CREATE TABLE IF NOT EXISTS PERSON
	(idPerson INT AUTO_INCREMENT,
	 userName CHAR(8),
	 lastName VARCHAR(16),
	 firstName VARCHAR(16),
	 salt CHAR(32),
	 hashValue CHAR(32),                    
	 CONSTRAINT pk_user PRIMARY KEY (idPerson),
	 CONSTRAINT ck_last CHECK (lastName IS NOT NULL),
	 CONSTRAINT ck_first CHECK (firstName IS NOT NULL),
	 UNIQUE KEY ix_person (lastName, firstName)
);

CREATE TABLE IF NOT EXISTS GROUPE
	(nameGrp VARCHAR(64),
	 CONSTRAINT pk_grp PRIMARY KEY (nameGrp),
	 UNIQUE KEY ix_grp (nameGrp)
);

-- CHILD TABLES
CREATE TABLE IF NOT EXISTS TICKET
	(idTicket INT AUTO_INCREMENT,
	 title VARCHAR(128),
	 nameGrp VARCHAR(64),
	 idPerson INT,
	 creationDate DATETIME,
	 CONSTRAINT pk_ticket PRIMARY KEY (idTicket),
	 CONSTRAINT ck_title CHECK (title IS NOT NULL),
	 CONSTRAINT ck_date CHECK (creationDate IS NOT NULL),
	 CONSTRAINT fk_ticket_grp FOREIGN KEY (nameGrp) REFERENCES GROUPE (nameGrp),
	 CONSTRAINT	fk_ticket_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson)
);

CREATE TABLE IF NOT EXISTS MESSAGE
	(idMsg INT AUTO_INCREMENT,
	 msgText TEXT,
	 color ENUM ('RED', 'ORANGE', 'GREEN'),
	 idTicket INT, 
	 idPerson INT,
	 writeDate DATETIME,
	 CONSTRAINT pk_msg PRIMARY KEY (idMsg),
	 CONSTRAINT ck_msg_ticket CHECK (idTicket IS NOT NULL),
	 CONSTRAINT ck_msg_pers CHECK (idPerson IS NOT NULL),
	 CONSTRAINT fk_msg_ticket FOREIGN KEY (idTicket) REFERENCES TICKET (idTicket), 
	 CONSTRAINT fk_msg_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson)
);

CREATE TABLE IF NOT EXISTS MEMBER_OF
	(idPerson INT,
	 nameGrp VARCHAR(64),
	 type ENUM ('CAMPUS', 'SERVICE'),
	 CONSTRAINT ck_member_of_grp CHECK (nameGrp IS NOT NULL),
	 CONSTRAINT ck_member_of_pers CHECK (nameGrp IS NOT NULL),
	 CONSTRAINT fk_member_of_grp FOREIGN KEY (nameGrp) REFERENCES GROUPE (nameGrp),
	 CONSTRAINT fk_member_of_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson),
	 CONSTRAINT pk_member_of PRIMARY KEY(nameGrp, idPerson),
     CONSTRAINT ck_type CHECK (type IS NOT NULL)
);

CREATE TABLE IF NOT EXISTS RECEIVE
	(idPerson INT,
	 idMsg INT,
	 status ENUM ('RECU', 'LU'),
	 CONSTRAINT ck_rcv_pers CHECK (idPerson IS NOT NULL),
	 CONSTRAINT ck_rcv_msg CHECK (idMsg IS NOT NULL),
	 CONSTRAINT fk_rcv_pers FOREIGN KEY (idPerson) REFERENCES PERSON (idPerson),
	 CONSTRAINT fk_rcv_msg FOREIGN KEY (idMsg) REFERENCES MESSAGE (idMsg),
	 CONSTRAINT pk_rcv PRIMARY KEY(idPerson, idMsg)
);

ALTER TABLE PERSON AUTO_INCREMENT=1000;
ALTER TABLE MESSAGE AUTO_INCREMENT=1;
ALTER TABLE TICKET AUTO_INCREMENT=1;

INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Barriol", "Luc");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Begg", "Alexandra");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Cabantos", "Claire");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Veillith", "Michel");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Vernier", "Florence");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Walbaum", "Ghislaine");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Walbaum", "Laurence");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Ziffer", "Elizabeth");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Arroui", "Sid");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Mmadi", "Anzilane");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Perrnot", "Patricia");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Poirier", "Francois");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Samson", "Christine");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Sciandra", "Philippe");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Snethlage", "Michel");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Teyssier", "Agnes");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Vernier", "Elisabeth");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Armand", "Michael");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Astier", "Nicole");
INSERT IGNORE INTO PERSON (lastName, firstName) VALUES ("Brunier", "Gilles");


INSERT IGNORE INTO GROUPE VALUES ("INFORMATIQUE");
INSERT IGNORE INTO GROUPE VALUES ("MECHANIQUE");
INSERT IGNORE INTO GROUPE VALUES ("BIOLOGIE");
INSERT IGNORE INTO GROUPE VALUES ("STAPS");
INSERT IGNORE INTO GROUPE VALUES ("TENNIS");
INSERT IGNORE INTO GROUPE VALUES ("FOOTBALL");
INSERT IGNORE INTO GROUPE VALUES ("NATATION");
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 1");
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 2");
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 3");
INSERT IGNORE INTO GROUPE VALUES ("GROUPE 4");
INSERT IGNORE INTO GROUPE VALUES ("GESTION DES EDT");
INSERT IGNORE INTO GROUPE VALUES ("SERVICES TECHNIQUES");
INSERT IGNORE INTO GROUPE VALUES ("GESTION DE L'ENTRETIEN DES SALLES");

INSERT IGNORE INTO MEMBER_OF VALUES (1000, "MECHANIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1000, "GROUPE 2", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "INFORMATIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "TENNIS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1001, "GROUPE 1", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1002, "BIOLOGIE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1002, "GROUPE 3", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1003, "STAPS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1004, "GESTION DES EDT", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1005, "MECHANIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1005, "NATATION", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "MECHANIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "FOOTBALL", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1006, "GROUPE 2", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1007, "SERVICE TECHNIQUES", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "INFORMATIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "GROUPE 1", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1008, "NATATION", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1009, "SERVICE TECHNIQUES", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1010, "GESTION DE L'ENTRETIEN DES SALLES", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1011, "STAPS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1011, "NATATION", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "BIOLOGIE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "MECHANIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1012, "INFORMATIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1013, "GESTION DES EDT", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1014, "GESTION DES EDT", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1015, "SERVICES TECHNIQUES", 'SERVICE');
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "INFORMATIQUE", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "TENNIS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1016, "GROUPE 3", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "STAPS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "TENNIS", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "FOOTBALL", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1017, "NATATION", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1018, "GROUPE 2", 'CAMPUS');
INSERT IGNORE INTO MEMBER_OF VALUES (1019, "GESTION DE L'ENTRETIEN DES SALLES", 'SERVICE');